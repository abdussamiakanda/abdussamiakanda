<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task2Printer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#94a3b8; --acc:#60a5fa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 12px; font-size: 22px; text-align: center; }
    p  { margin: 6px 0 14px; color: var(--muted); }
    .tabs { display:flex; gap:8px; margin: 8px 0 14px; }
    .tab { flex:1; text-align:center; padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid #1f2937; background:#0b1220; color:#cbd5e1; }
    .tab.active { background: #0a172a; border-color:#334155; color:#fff; }
    .grid { display:grid; gap:10px; }
    label { display:block; font-size:14px; color:#cbd5e1; margin-bottom:6px; }
    input, textarea, select { width:100%; padding:10px 12px; border-radius:10px; background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; outline:none; }
    textarea { min-height: 110px; resize: vertical; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    button { appearance:none; border:none; padding:12px 16px; border-radius:10px; background:var(--acc); color:#0b1220; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .status { margin-top:12px; font-size:14px; min-height:24px; }
    .ok { color:#86efac; }
    .err { color:#fca5a5; }
    .tiny { font-size:12px; color:#94a3b8; }
    .live { margin-top: 18px; font-size: 13px; white-space: pre-wrap; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; }
    .authbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; gap:10px; }
    .authinfo { font-size:14px; color:#cbd5e1; overflow:auto; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1><code>Task2Printer</code></h1>
    <div class="authbar">
      <div class="authinfo" id="authInfo">Signed out</div>
      <div style="display:flex; gap:8px;">
        <button id="btnSignIn">Sign in with Google</button>
        <button id="btnSignOut" style="display:none;">Sign out</button>
      </div>
    </div>
    <p>Choose “Plain Text” for a single line message, or “Event” for a structured payload.</p>

    <div class="tabs">
      <div class="tab active" id="tab-plain">Plain Text</div>
      <div class="tab" id="tab-event">Event</div>
    </div>

    <!-- Plain Text -->
    <div id="pane-plain">
      <div class="grid">
        <div>
          <label for="plainText">Text</label>
          <textarea id="plainText" placeholder="e.g. Print this quick note"></textarea>
        </div>
        <div class="row">
          <button id="sendPlain" disabled>Send Plain Text</button>
          <button id="clearPlain" type="button">Clear</button>
        </div>
      </div>
      <div class="status" id="statusPlain"></div>
    </div>

    <!-- Event -->
    <div id="pane-event" style="display:none;">
      <div class="grid">
        <div>
          <label for="eventName">Event Name</label>
          <input id="eventName" placeholder="e.g. Team Standup" />
        </div>
        <div class="row">
          <div>
            <label for="eventDate">Date</label>
            <input id="eventDate" type="date" />
          </div>
          <div>
            <label for="eventTime">Time</label>
            <input id="eventTime" type="time" />
          </div>
        </div>
        <div>
          <label for="eventDesc">Description (optional)</label>
          <textarea id="eventDesc" placeholder="e.g. Daily sync with quick updates."></textarea>
        </div>
        <div class="row">
          <button id="sendEvent" disabled>Send Event</button>
          <button id="clearEvent" type="button">Clear</button>
        </div>
      </div>
      <div class="tiny">Date/time is sent as ISO (local) string; your printer script formats AM/PM.</div>
      <div class="status" id="statusEvent"></div>
    </div>

    <div class="live tiny" id="liveInfo"></div>
  </div>
</div>

<!-- Firebase SDKs (v9+ modular) -->
<script type="module">
  // 1) Your Firebase config (already filled)
  const firebaseConfig = {
    apiKey: "AIzaSyD2FLUPlMF4tVFBPtIea1AUzM6RgWeaZ1o",
    authDomain: "life-abdussamiakanda.firebaseapp.com",
    databaseURL: "https://life-abdussamiakanda-default-rtdb.firebaseio.com",
    projectId: "life-abdussamiakanda",
    storageBucket: "life-abdussamiakanda.appspot.com",
    messagingSenderId: "699844726358",
    appId: "1:699844726358:web:98bb59195a9e33354bf5f7",
    measurementId: "G-S411V27PLT"
  };

  // 2) Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, push, serverTimestamp, onValue, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // 3) Init
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // UI elements
  const statusPlain = document.getElementById("statusPlain");
  const statusEvent = document.getElementById("statusEvent");
  const liveInfo    = document.getElementById("liveInfo");
  const btnSignIn   = document.getElementById("btnSignIn");
  const btnSignOut  = document.getElementById("btnSignOut");
  const authInfo    = document.getElementById("authInfo");

  const btnSendPlain = document.getElementById("sendPlain");
  const btnSendEvent = document.getElementById("sendEvent");

  // 4) Tabs
  const tabPlain = document.getElementById("tab-plain");
  const tabEvent = document.getElementById("tab-event");
  const panePlain = document.getElementById("pane-plain");
  const paneEvent = document.getElementById("pane-event");

  function setTab(which) {
    const isPlain = which === "plain";
    tabPlain.classList.toggle("active", isPlain);
    tabEvent.classList.toggle("active", !isPlain);
    panePlain.style.display = isPlain ? "" : "none";
    paneEvent.style.display = isPlain ? "none" : "";
  }
  tabPlain.onclick = () => setTab("plain");
  tabEvent.onclick = () => setTab("event");

  // 5) Auth
  btnSignIn.onclick = async () => {
    try { await signInWithPopup(auth, provider); }
    catch (e) { alert(e.message || String(e)); }
  };
  btnSignOut.onclick = async () => {
    try { await signOut(auth); }
    catch (e) { alert(e.message || String(e)); }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      const name  = user.displayName || "Anonymous";
      const email = user.email || "(no email)";
      authInfo.textContent = `Signed in as ${name} <${email}>`;
      btnSignIn.style.display = "none";
      btnSignOut.style.display = "";
      btnSendPlain.disabled = false;
      btnSendEvent.disabled = false;
    } else {
      authInfo.textContent = "Signed out";
      btnSignIn.style.display = "";
      btnSignOut.style.display = "none";
      btnSendPlain.disabled = true;
      btnSendEvent.disabled = true;
    }
  });

  // 6) Helpers
  const fmtOk  = (msg) => `<span class="ok">✔ ${msg}</span>`;
  const fmtErr = (msg) => `<span class="err">✖ ${msg}</span>`;

  function isoFromDateTime(dateStr, timeStr) {
    if (!dateStr && !timeStr) return null;
    try {
      if (dateStr && timeStr) {
        const dt = new Date(`${dateStr}T${timeStr}`);
        if (!Number.isNaN(dt.getTime())) return dt.toISOString();
      }
      if (dateStr) {
        const dt = new Date(`${dateStr}T00:00`);
        if (!Number.isNaN(dt.getTime())) return dt.toISOString();
      }
      if (timeStr) {
        const today = new Date();
        const stub = new Date(`${today.toISOString().slice(0,10)}T${timeStr}`);
        if (!Number.isNaN(stub.getTime())) return stub.toISOString();
      }
    } catch {}
    return null;
  }

  function requireUser() {
    const u = auth.currentUser;
    if (!u) throw new Error("Please sign in first.");
    return u;
  }

  // 7) Write functions
  async function sendPlain() {
    statusPlain.innerHTML = "";
    const text = document.getElementById("plainText").value.trim();
    if (!text) { statusPlain.innerHTML = fmtErr("Please enter some text."); return; }
    let user;
    try { user = requireUser(); } catch (e) { statusPlain.innerHTML = fmtErr(e.message || String(e)); return; }

    try {
      const newRef = ref(db, "todo/new");
      const res = await push(newRef, {
        text
      });
      statusPlain.innerHTML = fmtOk(`Posted as plain text.`);
      document.getElementById("plainText").value = "";
    } catch (e) {
      statusPlain.innerHTML = fmtErr(e.message || String(e));
    }
  }

  async function sendEvent() {
    statusEvent.innerHTML = "";
    const name = document.getElementById("eventName").value.trim();
    const date = document.getElementById("eventDate").value;
    const time = document.getElementById("eventTime").value;
    const desc = document.getElementById("eventDesc").value.trim();

    if (!name) { statusEvent.innerHTML = fmtErr("Event Name is required."); return; }
    let user;
    try { user = requireUser(); } catch (e) { statusEvent.innerHTML = fmtErr(e.message || String(e)); return; }

    const iso = isoFromDateTime(date, time);
    const payload = {
      event: name,
      datetime: iso || (date || time || null),
      description: desc || null,
      created_at: serverTimestamp()
    };

    try {
      const newRef = ref(db, "todo/new");
      const res = await push(newRef, payload);
      statusEvent.innerHTML = fmtOk(`Event posted.`);
      document.getElementById("eventName").value = "";
      document.getElementById("eventDate").value = "";
      document.getElementById("eventTime").value = "";
      document.getElementById("eventDesc").value = "";
    } catch (e) {
      statusEvent.innerHTML = fmtErr(e.message || String(e));
    }
  }

  document.getElementById("sendPlain").onclick = sendPlain;
  document.getElementById("clearPlain").onclick = () => {
    document.getElementById("plainText").value = "";
    statusPlain.innerHTML = "";
  };
  document.getElementById("sendEvent").onclick = sendEvent;
  document.getElementById("clearEvent").onclick = () => {
    document.getElementById("eventName").value = "";
    document.getElementById("eventDate").value = "";
    document.getElementById("eventTime").value = "";
    document.getElementById("eventDesc").value = "";
    statusEvent.innerHTML = "";
  };
</script>
</body>
</html>
